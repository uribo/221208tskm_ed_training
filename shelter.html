<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>高等学校情報科におけるR言語の活用 - オープンデータの活用</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "検索"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TFYL3R3FJ1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-TFYL3R3FJ1', { 'anonymize_ip': true});
</script>


<meta property="og:title" content="高等学校情報科におけるR言語の活用 - オープンデータの活用">
<meta property="og:description" content="オープンデータの取得から操作、可視化まで。">
<meta property="og:site-name" content="高等学校情報科におけるR言語の活用">
<meta name="twitter:title" content="高等学校情報科におけるR言語の活用 - オープンデータの活用">
<meta name="twitter:description" content="オープンデータの取得から操作、可視化まで。">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">高等学校情報科におけるR言語の活用</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">研修内容</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="./plot.html">
 <span class="dropdown-text">1. グラフの作成</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./shelter.html">
 <span class="dropdown-text">2. オープンデータの活用</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./mapping.html">
 <span class="dropdown-text">3. 地図へのマッピング</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./report.html">
 <span class="dropdown-text">4. レポート作成</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#パッケージの読み込み" id="toc-パッケージの読み込み" class="nav-link active" data-scroll-target="#パッケージの読み込み">1. パッケージの読み込み</a></li>
  <li><a href="#データの読み込み" id="toc-データの読み込み" class="nav-link" data-scroll-target="#データの読み込み">2. データの読み込み</a></li>
  <li><a href="#データの操作加工" id="toc-データの操作加工" class="nav-link" data-scroll-target="#データの操作加工">3. データの操作・加工</a></li>
  <li><a href="#グラフの作成" id="toc-グラフの作成" class="nav-link" data-scroll-target="#グラフの作成">4. グラフの作成</a></li>
  <li><a href="#まとめ" id="toc-まとめ" class="nav-link" data-scroll-target="#まとめ">5. まとめ</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/uribo/221208tskm_ed_training/issues/new" class="toc-action">問題を報告</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">オープンデータの活用</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>オープンデータの取得から操作、可視化まで。</p>
<p><a href="https://opendata.pref.tokushima.lg.jp">徳島県オープンデータポータルサイト</a>から<a href="https://opendata.pref.tokushima.lg.jp/dataset/487.html">緊急避難場所 (徳島県)</a>のデータをRで読み込み、処理します。 リンク先にはいくつかのデータがあります。ここでは「<code>洪水_登録データ一覧_2022年10月26日.csv (CSV 121KB)</code>」を例に解説を行います。</p>
<section id="パッケージの読み込み" class="level2">
<h2 class="anchored" data-anchor-id="パッケージの読み込み">1. パッケージの読み込み</h2>
<p>Rでは<strong>パッケージ</strong>と呼ばれる機能拡張をユーザーが自由に導入することが可能です。 パッケージの導入により、Rで実現可能な枠が広がります。 Rのインストール時に利用可能な、組み込みパッケージがありますが、これに加えていくつかのパッケージを導入しておくと、Rでの作業が快適になります。</p>
<p>パッケージの読み込みは<code>library({パッケージ名})</code>の形式で行います。 次のコードではいくつかのパッケージを読み込んでいます。 各パッケージがどのような機能をもつか、コメントとして示しました。 Rでは<code>#</code> 以降の文章はコメントとして扱われます。 コメントは、後からコードを見返した際、どのような処理をなぜ行ったのかを理解するのに役立つため、必要に応じて書いておくことが望ましいです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) <span class="co"># 表形式データの読み込み</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># データ操作</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># データ可視化</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here) <span class="co"># ファイルの指定を容易にする</span></span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="データの読み込み" class="level2">
<h2 class="anchored" data-anchor-id="データの読み込み">2. データの読み込み</h2>
<p>データをRへ読み込むには、次に示す通り、いくつかの方法があります。</p>
<ol type="1">
<li>対象ファイルを利用しているコンピュータのローカルディスクへ保存し、ファイルが置かれた場所（パス）を指定する</li>
<li>インターネット上に置かれたファイルのURLを指定する</li>
<li>RStudioのImport Dataset機能</li>
</ol>
<p>ここでは、すでにデータが手元にあることを想定し、1の方法でデータを読み込みます。<code>read_csv()</code>関数のfile引数にデータが保存されているパスを指定しましょう。 パスの値を<code>file = "パス"</code>の形式で記述します。パスを引用符 <code>"</code> で囲む必要がある点に注意してください。 Rでは文字列を引用符で囲むルールが存在します。 また、locale引数にもファイル読み込みのためのオプションを指定し、コードを実行します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data-raw/tksm_shelter_for_flood.csv"</span>),</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 読み込みのオプション</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 日本語が使われる一部のファイルを読み込むと、文字化けをすることがあります。</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># このファイルでも日本語が使われているため、次のオプションの指定で文字化けを回避します。</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">encoding =</span> <span class="st">"SHIFT-JIS"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 701 Columns: 19
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (6): タイトル, 所在地, 連絡先, 分類, 災害種別, 備考
dbl  (2): 緯度, 経度
lgl (11): 市町村, 写真1, 写真2, 写真3, 写真4, 写真5, 写真6, 写真7, 写真8, 写真9, 写真10...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 701 × 19
   市町村 タイトル  所在地  緯度  経度 写真1 写真2 写真3 写真4 写真5 写真6 写真7
   &lt;lgl&gt;  &lt;chr&gt;     &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt;
 1 NA     板野町防… 徳島…   34.1  134. NA    NA    NA    NA    NA    NA    NA   
 2 NA     新野小学… 阿南…   33.8  135. NA    NA    NA    NA    NA    NA    NA   
 3 NA     新野東小… 阿南…   33.8  135. NA    NA    NA    NA    NA    NA    NA   
 4 NA     阿南第二… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
 5 NA     桑野小学… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
 6 NA     山口小学… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
 7 NA     桑野公民… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
 8 NA     大井小学… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
 9 NA     加茂谷中… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
10 NA     阿南市ク… 阿南…   33.9  135. NA    NA    NA    NA    NA    NA    NA   
# … with 691 more rows, and 7 more variables: 写真8 &lt;lgl&gt;, 写真9 &lt;lgl&gt;,
#   写真10 &lt;lgl&gt;, 連絡先 &lt;chr&gt;, 分類 &lt;chr&gt;, 災害種別 &lt;chr&gt;, 備考 &lt;chr&gt;</code></pre>
</div>
</div>
<p>Rでは処理の結果を再利用するために、オブジェクトを利用します。 読み込んだデータに対して、処理を加えるためにオブジェクトとして保存しましょう。 オブジェクトへの保存は「代入」とも呼ばれます。 代入は <code>&lt;-</code> （代入演算子）の左側に保存先のオブジェクト名、右側に保存したい処理内容を記述して実行します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 読み込んだcsvの内容を df_hinanjyo として記録する</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_hinanjyo <span class="ot">&lt;-</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data-raw/tksm_shelter_for_flood.csv"</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">encoding =</span> <span class="st">"SHIFT-JIS"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 701 Columns: 19
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (6): タイトル, 所在地, 連絡先, 分類, 災害種別, 備考
dbl  (2): 緯度, 経度
lgl (11): 市町村, 写真1, 写真2, 写真3, 写真4, 写真5, 写真6, 写真7, 写真8, 写真9, 写真10...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>オブジェクトに保存した内容（値）はいつでも呼び出すことができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># コンソールでオブジェクト名を実行すると値が呼び出される</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_hinanjyo</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>読み込んだファイルのように、表形式で表現されるデータのことをRではデータフレームと呼びます。 データフレームは表計算ソフトのように1行1列それぞれに値が格納されています。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/excel.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">洪水_登録データ一覧を表計算ソフトで表示した画面。Rでの読み込み結果が正しく行われていることを確認しましょう。</figcaption><p></p>
</figure>
</div>
<p>上記のようにオブジェクト名をコンソールで実行してデータフレームを表示することもできますが、 データフレームの中身を確認する関数はいくつかあります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(df_hinanjyo)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># データ中の各変数の値を縦方向に出力します</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(df_hinanjyo)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 701
Columns: 19
$ 市町村   &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ タイトル &lt;chr&gt; "板野町防災ステーション", "新野小学校", "新野東小学校", "阿南…
$ 所在地   &lt;chr&gt; "徳島県板野郡板野町川端字新手崎18-1", "阿南市新野町南宮ノ久保…
$ 緯度     &lt;dbl&gt; 34.13761, 33.84699, 33.84517, 33.87679, 33.87358, 33.87303, 3…
$ 経度     &lt;dbl&gt; 134.4729, 134.5811, 134.6042, 134.6283, 134.6118, 134.5819, 1…
$ 写真1    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真2    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真3    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真4    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真5    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真6    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真7    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真8    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真9    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 写真10   &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ 連絡先   &lt;chr&gt; "088-637-5585", "0884-36-2021", "0884-36-2103", "0884-26-0203…
$ 分類     &lt;chr&gt; "指定緊急避難場所（法指定）", "指定緊急避難場所（法指定）", "…
$ 災害種別 &lt;chr&gt; "洪水,崖崩れ等,地震,大規模な火事,内水氾濫", "洪水,崖崩れ等,地…
$ 備考     &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</code></pre>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
ノート
</div>
</div>
<div class="callout-body-container callout-body">
<p>インターネットが利用できない環境では、URLを指定したデータの読み込みが行えません。 ローカルディスクにファイルをダウンロードしておくことで、インターネット非接続状態でもファイルの読み込みが可能になります。 次のコマンドを実行するとファイルのダウンロード、ローカルでのパスを指定したファイルの読み込みが行われます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">dir_create</span>(<span class="fu">here</span>(<span class="st">"data-raw"</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># インターネット上のファイルをダウンロードする（ここではインターネット接続が必要です）</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="st">"https://opendata.pref.tokushima.lg.jp/dataset/487/resource/6553/洪水_登録データ一覧_2022年10月26日_15時14分.csv"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>              <span class="co"># data-rawフォルダの中に tksm_shelter_for_flood.csv として保存します</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">here</span>(<span class="st">"data-raw/tksm_shelter_for_flood.csv"</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 保存したcsvファイルのパスをfile引数で指定します</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>df_hinanjyo <span class="ot">&lt;-</span> </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="fu">here</span>(<span class="st">"data-raw/tksm_shelter_for_flood.csv"</span>),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">encoding =</span> <span class="st">"SHIFT-JIS"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/donwload_file.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">ダウンロードしたファイルとフォルダの関係</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
ノート
</div>
</div>
<div class="callout-body-container callout-body">
<p>上記の処理はRStudioのFile import機能を使っても行えます。 この機能には、データの読み込み結果をプレビューできる、Rのコード入力を最低限に抑えることができるなどの利点があります。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rstudio_import_dataset.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">RStudioのImport dataset機能を使ったデータ読み込み</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="データの操作加工" class="level2">
<h2 class="anchored" data-anchor-id="データの操作加工">3. データの操作・加工</h2>
<p>データを読み込んだ後は自由自在にデータを操作したり加工を行うことができます。 以下に示すとおり、データ操作に便利な関数を提供するdplyrパッケージを使ってデータに変更を加えていきましょう。</p>
<ul>
<li><code>select()</code>… 列の選択</li>
<li><code>filter()</code>… 行の絞り込み</li>
<li><code>mutate()</code>, <code>transmute()</code>… 値の編集</li>
<li><code>group_by()</code>, <code>summarise()</code> … グループごとに値を集計する</li>
<li><code>arrange()</code>… 行の並び替え</li>
<li><code>count()</code>… 項目の頻度を数える</li>
<li><code>*_join()</code> … データフレームの結合</li>
</ul>
<p>データフレームを確認するとわかるように、このデータには複数の「写真」の列が存在します。 これらの列の中には値がありません。 値がない状態を「欠損」は呼ばれ、そのことを表現するために欠損値 (<code>NA</code>) が使われます。 こうした欠損値からなる列は不要と判断し、列を絞り込みましょう。 列の選択は<code>select()</code>関数で行います。この関数の引数に、残したい、または削除したい変数を記述して実行します<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。 関心のある列にデータを制限することで、データの見通しがよくなります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_hinanjyo <span class="ot">&lt;-</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 関心のある列を選び直す</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(df_hinanjyo,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">市町村</span><span class="st">`</span>, <span class="st">`</span><span class="at">タイトル</span><span class="st">`</span>, <span class="st">`</span><span class="at">所在地</span><span class="st">`</span>, <span class="st">`</span><span class="at">緯度</span><span class="st">`</span>, <span class="st">`</span><span class="at">経度</span><span class="st">`</span>, <span class="st">`</span><span class="at">分類</span><span class="st">`</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(df_hinanjyo)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 701
Columns: 6
$ 市町村   &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ タイトル &lt;chr&gt; "板野町防災ステーション", "新野小学校", "新野東小学校", "阿南…
$ 所在地   &lt;chr&gt; "徳島県板野郡板野町川端字新手崎18-1", "阿南市新野町南宮ノ久保…
$ 緯度     &lt;dbl&gt; 34.13761, 33.84699, 33.84517, 33.87679, 33.87358, 33.87303, 3…
$ 経度     &lt;dbl&gt; 134.4729, 134.5811, 134.6042, 134.6283, 134.6118, 134.5819, 1…
$ 分類     &lt;chr&gt; "指定緊急避難場所（法指定）", "指定緊急避難場所（法指定）", "…</code></pre>
</div>
</div>
<p>加えて、日本語の列名から英語での列名に変更します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 緯度 ... latitude</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 経度 ... longitude</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_hinanjyo) <span class="ot">&lt;-</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"city"</span>, <span class="st">"title"</span>, <span class="st">"address"</span>, <span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"type"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_hinanjyo)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  city  title                  address                     latit…¹ longi…² type 
  &lt;lgl&gt; &lt;chr&gt;                  &lt;chr&gt;                         &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;
1 NA    板野町防災ステーション 徳島県板野郡板野町川端字新…    34.1    134. 指定…
2 NA    新野小学校             阿南市新野町南宮ノ久保70-1     33.8    135. 指定…
3 NA    新野東小学校           阿南市新野町是国37-2           33.8    135. 指定…
4 NA    阿南第二中学校         阿南市内原町竹ノ内口143-1      33.9    135. 指定…
5 NA    桑野小学校             阿南市桑野町岡元40-1           33.9    135. 指定…
6 NA    山口小学校             阿南市山口町末広12-1           33.9    135. 指定…
# … with abbreviated variable names ¹​latitude, ²​longitude</code></pre>
</div>
</div>
<p>ここで<code>city</code>列に注目します。 この列は避難所の位置する市町村を記録すべき列ですが、いずれの行にも値は含まれません。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cityの項目を数える --&gt; NA (欠損値)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">count</span>(df_hinanjyo, city)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  city      n
  &lt;lgl&gt; &lt;int&gt;
1 NA      701</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 欠損値の行を確認</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(df_hinanjyo, <span class="fu">is.na</span>(city))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 欠損値でない行を確認</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(df_hinanjyo, <span class="sc">!</span><span class="fu">is.na</span>(city))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>そこで避難所の住所を記録した<code>address</code>列の値から市町村名の部分だけを抜き出して、 <code>city</code>列を上書きすることを考えましょう。 <code>address</code>には徳島県板野郡板野町川端字新手崎18-1のように住所が文字列として記録されています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1行目の住所を表示</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_hinanjyo<span class="sc">$</span>address[<span class="dv">1</span>]</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "徳島県板野郡板野町川端字新手崎18-1"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># すべての住所を表示</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df_hinanjyo$address</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 県名を含む住所から市町村の部分を取り出す</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>stringr<span class="sc">::</span><span class="fu">str_extract</span>(df_hinanjyo<span class="sc">$</span>address[<span class="dv">1</span>], </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pattern =</span> <span class="st">"(.{2}郡.{2,3}町|.{2,3}(市|町|村))"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "板野郡板野町"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>stringr<span class="sc">::</span><span class="fu">str_remove</span>(df_hinanjyo<span class="sc">$</span>address[<span class="dv">1</span>], <span class="st">"徳島県"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>stringr<span class="sc">::</span><span class="fu">str_extract</span>(df_hinanjyo<span class="sc">$</span>address[<span class="dv">1</span>], <span class="st">".{2}郡.{2,3}町"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(<span class="fu">is.na</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(df_hinanjyo<span class="sc">$</span>address, <span class="st">"(.{2}郡.{2,3}町|.{2,3}(市|町|村))"</span>)))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>df_hinanjyo<span class="sc">$</span>address[x]</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>すべての行にこの処理を適用しましょう。 <code>mutate()</code>関数を使って、任意の処理を各行へ適用可能です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_hinanjyo <span class="ot">&lt;-</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(df_hinanjyo,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>         <span class="co"># 住所から市町村名の部分を取り出し、city列に格納する</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">city =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(address, <span class="st">"(.{2}郡.{2,3}町|.{2,3}(市|町|村))"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>結果を確認します。 先ほど<code>count()</code>関数で<code>city</code>列の項目を数えた際には欠損値だけでしたが、 今度は市町村別の避難場所のカウントが正しく行われているように見えます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_tokushima_hinanjyo_count <span class="ot">&lt;-</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sort = TRUE ... 市町村の項目が多い順（降順）に出力する</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(df_hinanjyo, city, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>df_tokushima_hinanjyo_count</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46 × 2
   city         n
   &lt;chr&gt;    &lt;int&gt;
 1 三好市     190
 2 &lt;NA&gt;        75
 3 鳴門市      72
 4 阿南市      52
 5 板野町      35
 6 勝浦町      34
 7 松茂町      21
 8 石井町      21
 9 吉野川市    18
10 美馬市      17
# … with 36 more rows</code></pre>
</div>
</div>
<p>なお、この処理は<code>group_by()</code>関数と<code>summarise()</code>関数を組み合わせても実行できます。<code>group_by()</code>は指定した列の項目ごとにグループを作成し、グループに対する操作を可能にします。 <code>summarise()</code>関数はそうしたグループへの集計を行う際に利用します。 例えば、クラスで行った教科ごとの平均点を求める際、教科をグループとしてその平均値を求める、といった処理がこの2つの関数を組み合わせることで可能となります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 下記と同じ結果を得る</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># count(df_hinanjyo, city, sort = TRUE)</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">arrange</span>(<span class="fu">summarise</span>(<span class="fu">group_by</span>(df_hinanjyo,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                           city),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">desc</span>(n))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>グループ化した項目を数えるのに<code>n()</code>関数を使います。 このようなグループごとの項目の集計は頻繁に行う処理のため、ショートカットとして<code>count()</code>関数が用意されています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># いくつかの行は欠損値のまま</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(df_tokushima_hinanjyo_count, <span class="fu">is.na</span>(city))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  city      n
  &lt;chr&gt; &lt;int&gt;
1 &lt;NA&gt;     75</code></pre>
</div>
</div>
<p>市町村別の避難場所の集計結果を見ると、三好市が最も数が多いことがわかります。 しかしこの値は人口や面積を考慮した値ではありません。 人口や面積の単位あたりの避難場所の数を比較することで、市町村別の評価が可能となります。</p>
<p><a href="plot.html">グラフの作成</a>で利用した<a href="https://www.nstac.go.jp/use/literacy/ssdse/">教育用標準データセット</a>の中には、市区町村別の統計データを記録したものもあります。 データはすでにダウンロードされ、徳島県の市町村に関する情報が参照できる状態となっています。 次のコマンドを実行し、データをRに読み込みましょう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_ssdse_a_tiny_tokushima <span class="ot">&lt;-</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_rds</span>(<span class="fu">here</span>(<span class="st">"data-raw/ssdse_a_tiny_tokushima.rds"</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>df_ssdse_a_tiny_tokushima</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 4
   市区町村 `人口・世帯数_総人口` `総面積（北方地域及び竹島を除く）` 可住地面積
   &lt;chr&gt;                    &lt;dbl&gt;                              &lt;dbl&gt;      &lt;dbl&gt;
 1 徳島市                  252391                              19139      14096
 2 鳴門市                   54622                              13566       6466
 3 小松島市                 36149                               4537       3882
 4 阿南市                   69470                              27925      12892
 5 吉野川市                 38772                              14414       6128
 6 阿波市                   34713                              19111       9003
 7 美馬市                   28055                              36714       7504
 8 三好市                   23605                              72142       8915
 9 勝浦町                    4837                               6983       2264
10 上勝町                    1380                              10963       1264
# … with 14 more rows</code></pre>
</div>
</div>
<p>dplyrパッケージではデータフレームを結合する関数<code>*_join()</code>を提供します。 関数の引数に対象となる2つのデータフレームを指定し、結合の際のキーとなる変数を引数byに与えて実行します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_tokushima_hinanjyo_count <span class="ot">&lt;-</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  df_tokushima_hinanjyo_count,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  df_ssdse_a_tiny_tokushima,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"city"</span> <span class="ot">=</span> <span class="st">"市区町村"</span>))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>df_tokushima_hinanjyo_count</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 5
   city         n `人口・世帯数_総人口` 総面積（北方地域及び竹島を除く…¹ 可住…²
   &lt;chr&gt;    &lt;int&gt;                 &lt;dbl&gt;                            &lt;dbl&gt;  &lt;dbl&gt;
 1 三好市     190                 23605                            72142   8915
 2 鳴門市      72                 54622                            13566   6466
 3 阿南市      52                 69470                            27925  12892
 4 板野町      35                 13042                             3622   1964
 5 勝浦町      34                  4837                             6983   2264
 6 松茂町      21                 14583                             1424   1418
 7 石井町      21                 24833                             2885   2648
 8 吉野川市    18                 38772                            14414   6128
 9 美馬市      17                 28055                            36714   7504
10 阿波市      17                 34713                            19111   9003
11 北島町      15                 22745                              874    874
12 美波町      15                  6222                            14074   1541
13 上板町      11                 11384                             3458   2243
14 神山町       9                  4647                            17330   2419
15 藍住町       8                 35246                             1627   1627
16 上勝町       5                  1380                            10963   1264
# … with abbreviated variable names ¹​`総面積（北方地域及び竹島を除く）`,
#   ²​可住地面積</code></pre>
</div>
</div>
<p><code>city</code>と<code>n</code>の2列からなるデータフレーム<code>df_tokushima_hinanjyo_count</code>に、<code>df_ssdse_a_tiny_tokushima</code>がもつ列の情報が加わったことがわかります。</p>
<p>追加された情報から、避難場所の数を単位当たり数を求めてみます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 災害種別_洪水</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>df_tokushima_hinanjyo_count <span class="ot">&lt;-</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(df_tokushima_hinanjyo_count,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">市町村</span><span class="st">`</span> <span class="ot">=</span> city,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">避難場所件数</span><span class="st">`</span> <span class="ot">=</span> n,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">避難場所件数(人口1万人あたり)</span><span class="st">`</span> <span class="ot">=</span> (n <span class="sc">/</span> <span class="st">`</span><span class="at">人口・世帯数_総人口</span><span class="st">`</span>) <span class="sc">*</span> <span class="dv">10000</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>df_tokushima_hinanjyo_count <span class="ot">&lt;-</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 人口1万人当たりの避難場所件数の順に並び替え</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(df_tokushima_hinanjyo_count,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">desc</span>(<span class="st">`</span><span class="at">避難場所件数(人口1万人あたり)</span><span class="st">`</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>人口1万人あたりで見ても、三好市の避難場所件数が最も多いことに変わりはありませんでしたが、 勝浦川の流域に位置する勝浦町、上勝町が上位になりました。</p>
</section>
<section id="グラフの作成" class="level2">
<h2 class="anchored" data-anchor-id="グラフの作成">4. グラフの作成</h2>
<p>続いて、市町村別に避難場所の数を集計したデータ <code>df_tokushima_hinanjyo_count</code> をもとに、簡単なグラフを作成してみましょう。</p>
<p>避難場所の数（数量）を市町村で比較する際、適したグラフの種類は何でしょうか。 ここでは棒グラフと円グラフによるグラフ作成の例を示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> df_tokushima_hinanjyo_count,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(市町村, 避難場所件数)) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 棒グラフの指定</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="co"># n （市町村別の避難場所の数）が棒の高さに用いられる</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"#3F54B4"</span> <span class="co"># 棒の塗りつぶしの色</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="shelter_files/figure-html/shelter_count-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">徳島県内緊急避難場所（災害種別 洪水）の市町村別件数</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><code>geom_bar()</code>関数を指定して棒グラフを描画しましたが、このグラフはいくつかの理由で情報を適切に伝えられていません。 例えば、</p>
<ol type="1">
<li>x軸の市町村の間隔が狭いために文字が潰れてしまっている</li>
<li>x軸の市町村の並びと避難場所の件数に関係がなく、関係を読み取りにくい</li>
</ol>
<p>この問題を改善してみましょう。 まず、1の問題はx軸に複数の項目を並べる際に生じる問題です。 特に項目数が多い場合、横幅を広くとらないと文字が潰れてしまいます。 根本的な対策は、x軸とy軸を入れ替えて表示することです。 これにより、項目の間隔を気にする必要がなくなります（ただし高さを十分にする）。 すでに作成したグラフに対して、<code>coord_flip()</code>関数を適用するとx軸とy軸の入れ替えが行われます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="shelter_files/figure-html/shelter_count_coord_flip-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">徳島県内緊急避難場所（災害種別 洪水）の市町村別件数（市町村別の並びを縦に変更）</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>続いて市町村名と避難場所の件数の関係をわかりやすく伝える工夫をしてみます。 現在の図は適当に市町村名が並んでいるように見えるため、避難場所の件数で入れ替えるようにします。 合わせてグラフ全体の見た目も調整しておきましょう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> df_tokushima_hinanjyo_count,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(市町村, 避難場所件数), 避難場所件数)) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="st">"#3F54B4"</span>) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"避難場所の件数"</span>) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"徳島県内緊急避難場所（災害種別 洪水）の市町村別件数"</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="shelter_files/figure-html/shelter_count_coord_modify-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">徳島県内緊急避難場所（災害種別 洪水）の市町村別件数</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">5. まとめ</h2>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
演習
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>徳島県オープンデータポータルサイトから適当なデータを見つけ、ファイルをRに読み込みましょう。</p></li>
<li><p>読み込んだデータをdplyrパッケージのデータ操作のための関数を使って処理してみましょう。</p></li>
</ol>
<ul>
<li><code>select()</code></li>
<li><code>filter()</code></li>
<li><code>mutate()</code>, <code>transmute()</code></li>
<li><code>group_by()</code>, <code>summarise()</code></li>
<li><code>arrange()</code></li>
<li><code>count()</code></li>
<li><code>*_join()</code></li>
</ul>
<p>などの関数が利用できます</p>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>列を削除するには、列名の前に<code>!</code>を付けて実行します。例) <code>select(df_hinanjyo, !c(</code>市町村<code>,</code>分類<code>))</code><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "コピーしました");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "コピーしました");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/uribo">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/u_ribo">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>